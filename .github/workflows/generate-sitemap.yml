name: Generate Sitemap

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # Ø§Ù…Ú©Ø§Ù† Ø§Ø¬Ø±Ø§ Ø¯Ø³ØªÛŒ Ø§Ø² ØªØ¨ Actions

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Create sitemap generator script
        run: |
          echo "const fs = require('fs');
          const glob = require('glob');

          const htmlFiles = glob.sync('**/*.html', {
            ignore: 'node_modules/**',
            nodir: true
          });

          const baseUrl = 'https://www.dash-smal.ir';
          const today = new Date().toISOString().split('T')[0];

          let sitemap = \`<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.sitemaps.org/schemas/sitemap/0.9
        http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd">

\`;

          htmlFiles.forEach(file => {
            const url = file === 'index.html' ? '/' : '/' + file;
            const fullUrl = baseUrl + url;
            const priority = url === '/' ? '1.0' : '0.8';
            const changefreq = url === '/' ? 'weekly' : 'monthly';

            sitemap += \`  <url>
    <loc>\${fullUrl}</loc>
    <lastmod>\${today}</lastmod>
    <changefreq>\${changefreq}</changefreq>
    <priority>\${priority}</priority>
  </url>

\`;
          });

          sitemap += '</urlset>';

          fs.writeFileSync('sitemap.xml', sitemap, 'utf8');
          console.log('âœ… sitemap.xml Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯.');
          " > generate-sitemap.js

      - name: Install glob
        run: npm install glob

      - name: Run generator
        run: node generate-sitemap.js

      - name: Commit and push if changed
        run: |
          git config --local user.name "Sitemap Bot"
          git config --local user.email "bot@dash-smal.ir"
          git add sitemap.xml
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ¤– Auto-update sitemap.xml" && git push)
