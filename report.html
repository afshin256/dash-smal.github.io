<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>گزارش سفارش‌ها</title>

  <!-- SheetJS (برای دانلود اکسل) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg: #000000;
      --text: #e6eef0;
      --muted: #bfc8ca;
      --btn-turq: #00e5ff;
      --btn-turq-hover: #00bcd4;
      --neon-orange: #ff6a00; /* هدر */
      --row-dark: #0f0f0f;
      --row-darker: #1a1a1a;
    }
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: "Tahoma", "Vazirmatn", sans-serif;
      padding:20px;
      box-sizing:border-box;
    }
    h1{
      text-align:center;
      color:var(--btn-turq);
      margin:6px 0 14px;
    }

    .controls{
      text-align:center;
      margin-bottom:12px;
    }
    .btn{
      background:var(--btn-turq);
      color:#000;
      border:none;
      padding:10px 16px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
      margin:6px;
    }
    .btn:hover{background:var(--btn-turq-hover)}

    #status{
      text-align:center;
      color:var(--muted);
      margin-top:8px;
      font-size:13px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:14px;
      table-layout:fixed;
      font-size:13px;
      direction:rtl;
    }
    thead th{
      position:sticky;
      top:0;
      z-index:3;
      background:linear-gradient(180deg, var(--neon-orange), #ff8a33);
      color:#000;
      padding:10px 8px;
      text-align:center;
      cursor:pointer;
      user-select:none;
    }
    tbody td{
      padding:10px 8px;
      border-bottom:1px solid rgba(255,255,255,0.04);
      text-align:center;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    tbody tr:nth-child(even){background:var(--row-darker)}
    tbody tr:nth-child(odd){background:var(--row-dark)}
    .small{font-size:12px;color:var(--muted)}
    /* responsive */
    @media (max-width:900px){
      thead th, tbody td{font-size:12px;padding:8px}
    }
  </style>
</head>
<body>

  <h1>📊 گزارش سفارش‌ها</h1>

  <div class="controls">
    <button class="btn" onclick="downloadExcel()">⬇ دانلود اکسل</button>
    <!-- بعداً دکمه‌های حذف اضافه می‌کنیم -->
  </div>

  <div id="status">در حال بارگذاری داده‌ها…</div>

  <table id="logsTable" aria-label="Logs table">
    <thead>
      <tr id="tableHeader"></tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script>
    // لینک وب‌اپ گوگل شیت (بدون callback) — JSONP با اضافه کردن &callback=... ساخته می‌شود
    const apiBase = "https://script.google.com/macros/s/AKfycbwjHup4PINdXvx2WL4luUPHH4eVvEyJ-c7AUW3U5yc/dev?mode=getLogs";

    // ترتیب ستون‌ها و عنوان نمایش داده‌شده (بسته به خروجی doGet شما)
    const colKeys = [
      "table","duration","deviceType","browser","os",
      "screen","lang","referrer","items","total","recipient"
    ];
    const colLabels = {
      table: "Table",
      duration: "Duration (sec)",
      deviceType: "Device Type",
      browser: "Browser",
      os: "OS",
      screen: "Screen Resolution",
      lang: "Language",
      referrer: "Referrer",
      items: "Ordered Items",
      total: "Total Amount",
      recipient: "Recipient"
    };

    let logsData = [];
    let sortDirection = {}; // برای هر ستون: "asc" یا "desc"
    const statusEl = document.getElementById("status");

    // === تابع JSONP برای بارگذاری داده (جایگزین fetch برای دور زدن CORS) ===
    function fetchLogsJSONP(timeoutMs = 10000) {
      statusEl.textContent = "در حال اتصال به وب‌اپ گوگل شیت…";
      const callbackName = "_gLogsCallback_" + Date.now();
      // ایجاد callback سراسری
      window[callbackName] = function(data) {
        clearTimeout(timeoutId);
        cleanup();
        if (!Array.isArray(data)) data = [];
        logsData = data;
        statusEl.textContent = "داده‌ها بارگذاری شد. ردیف‌ها: " + logsData.length;
        renderTable(logsData);
      };

      // در صورت خطا/Timeout
      const onError = () => {
        cleanup();
        statusEl.textContent = "خطا در دریافت داده‌ها — ممکن است وب‌اپ قابل دسترسی نباشد یا پاسخ معیوب باشد.";
        console.error("JSONP load failed");
      };

      // ایجاد تگ اسکریپت
      const script = document.createElement("script");
      script.id = callbackName;
      script.src = apiBase + "&callback=" + callbackName;
      script.onerror = onError;
      document.body.appendChild(script);

      // timeout
      const timeoutId = setTimeout(() => {
        onError();
      }, timeoutMs);

      // پاک‌سازی callback و تگ اسکریپت بعد از اجرا یا خطا
      function cleanup() {
        try{ delete window[callbackName]; }catch(e){ window[callbackName]=undefined; }
        const s = document.getElementById(callbackName);
        if (s && s.parentNode) s.parentNode.removeChild(s);
        clearTimeout(timeoutId);
      }
    }

    // === رندر جدول ===
    function renderTable(data) {
      const headerRow = document.getElementById("tableHeader");
      const body = document.getElementById("tableBody");
      headerRow.innerHTML = "";
      body.innerHTML = "";

      if (!data || data.length === 0) {
        body.innerHTML = "<tr><td colspan='" + colKeys.length + "' class='small'>هیچ داده‌ای موجود نیست</td></tr>";
        return;
      }

      // ساخت هدر با قابلیت کلیک برای مرتب‌سازی
      colKeys.forEach(key => {
        const th = document.createElement("th");
        th.textContent = colLabels[key] || key;
        th.title = "برای مرتب‌سازی کلیک کنید";
        th.onclick = () => sortTable(key);
        headerRow.appendChild(th);
      });

      // ردیف‌ها
      data.forEach((rowObj, idx) => {
        const tr = document.createElement("tr");
        colKeys.forEach(key => {
          const td = document.createElement("td");
          let v = rowObj[key];
          if (v === null || v === undefined) v = "";
          td.textContent = v;
          tr.appendChild(td);
        });
        body.appendChild(tr);
      });
    }

    // === مرتب‌سازی با تشخیص عددی/متنی ===
    function sortTable(column) {
      const dir = sortDirection[column] === "asc" ? "desc" : "asc";
      sortDirection[column] = dir;

      logsData.sort((a,b) => {
        let A = a[column];
        let B = b[column];

        // تشخیص عددی
        const aNum = parseFloat(String(A).replace(/[^\d.-]/g,""));
        const bNum = parseFloat(String(B).replace(/[^\d.-]/g,""));
        const bothNum = !isNaN(aNum) && !isNaN(bNum);

        if (bothNum) {
          return dir === "asc" ? (aNum - bNum) : (bNum - aNum);
        } else {
          // مقایسه لوکالایزد رشته‌ای
          A = String(A || "").toLowerCase();
          B = String(B || "").toLowerCase();
          if (A < B) return dir === "asc" ? -1 : 1;
          if (A > B) return dir === "asc" ? 1 : -1;
          return 0;
        }
      });

      renderTable(logsData);
      statusEl.textContent = `مرتب شد بر اساس "${colLabels[column] || column}" (${dir}) — ردیف‌ها: ${logsData.length}`;
    }

    // === دانلود اکسل با SheetJS ===
    function downloadExcel() {
      if (!logsData || logsData.length === 0) {
        alert("هیچ داده‌ای برای دانلود وجود ندارد.");
        return;
      }
      // تبدیل به آرایه‌ای از اشیاء با کلیدهای خوانا (عنوان ستون‌ها)
      const out = logsData.map(row => {
        const obj = {};
        colKeys.forEach(k => obj[colLabels[k] || k] = row[k]);
        return obj;
      });
      const ws = XLSX.utils.json_to_sheet(out);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Logs");
      XLSX.writeFile(wb, "restaurant_logs.xlsx");
    }

    // اجرای JSONP برای بارگذاری اولیه
    fetchLogsJSONP();

    // (اختیاری) تابع عمومی برای ریفِرش دستی
    window.refreshLogs = () => { statusEl.textContent = "بارگذاری مجدد…"; fetchLogsJSONP(); };
  </script>
</body>
</html>
