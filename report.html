<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TOUCAN - گزارش‌گیری</title>
  <style>
    body { font-family: 'Segoe UI', 'Helvetica Neue', Tahoma, Arial; background: #0b0b0b; color: #eee; margin: 0; padding: 20px; }
    .header { padding: 12px 0; font-size: 24px; font-weight: bold; text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #333; padding: 8px; text-align: right; }
    th { background: #222; }
    button { background: #0ea5b7; color: #fff; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 20px; }
    #report-table { overflow-x: auto; }
    @media (max-width: 768px) { table { font-size: 12px; } }
  </style>
</head>
<body>
  <div class="header">گزارش‌گیری سفارش‌ها - TOUCAN</div>
  <button id="export-csv">دانلود گزارش به عنوان report.csv</button>
  <div id="report-table"></div>

<script>
(() => {
  function loadReports() {
    try {
      const raw = localStorage.getItem('toucan_reports') || '[]';
      return JSON.parse(raw);
    } catch (e) {
      console.warn('Error loading reports:', e);
      return [];
    }
  }

  function renderReports(reports) {
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    const headers = ['زمان ارسال', 'میز', 'مدت زمان حضور (ثانیه)', 'نوع دستگاه', 'مرورگر', 'سیستم‌عامل', 'رزولوشن صفحه', 'زبان کاربر', 'منبع ورود', 'غذاهای سفارش‌شده', 'مجموع مبلغ', 'دریافت‌کننده'];
    headers.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    reports.forEach(report => {
      const row = document.createElement('tr');
      [
        report.timestamp,
        report.table,
        report.duration_seconds,
        report.device_type,
        report.browser,
        report.os,
        report.screen_resolution,
        report.user_language,
        report.referrer,
        report.items,
        report.total,
        report.recipient
      ].forEach(val => {
        const td = document.createElement('td');
        td.textContent = val;
        row.appendChild(td);
      });
      tbody.appendChild(row);
    });
    table.appendChild(tbody);

    document.getElementById('report-table').appendChild(table);
  }

  function exportToCSV(reports) {
    const csvHeaders = ['timestamp', 'table', 'duration_seconds', 'device_type', 'browser', 'os', 'screen_resolution', 'user_language', 'referrer', 'items', 'total', 'recipient'];
    let csvContent = csvHeaders.join(',') + '\n';
    reports.forEach(report => {
      const row = csvHeaders.map(key => `"${report[key].toString().replace(/"/g, '""')}"`).join(',');
      csvContent += row + '\n';
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', 'report.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  const reports = loadReports();
  renderReports(reports);

  document.getElementById('export-csv').addEventListener('click', () => exportToCSV(reports));
})();
</script>
</body>
</html>