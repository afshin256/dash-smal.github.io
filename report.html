<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ú¯Ø²Ø§Ø±Ø´ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</title>

  <!-- SheetJS (Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ú©Ø³Ù„) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg: #000000;
      --text: #e6eef0;
      --muted: #bfc8ca;
      --btn-turq: #00e5ff;
      --btn-turq-hover: #00bcd4;
      --neon-orange: #ff6a00; /* Ù‡Ø¯Ø± */
      --row-dark: #0f0f0f;
      --row-darker: #1a1a1a;
    }
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: "Tahoma", "Vazirmatn", sans-serif;
      padding:20px;
      box-sizing:border-box;
    }
    h1{
      text-align:center;
      color:var(--btn-turq);
      margin:6px 0 14px;
    }

    .controls{
      text-align:center;
      margin-bottom:12px;
    }
    .btn{
      background:var(--btn-turq);
      color:#000;
      border:none;
      padding:10px 16px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
      margin:6px;
    }
    .btn:hover{background:var(--btn-turq-hover)}

    #status{
      text-align:center;
      color:var(--muted);
      margin-top:8px;
      font-size:13px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:14px;
      table-layout:fixed;
      font-size:13px;
      direction:rtl;
    }
    thead th{
      position:sticky;
      top:0;
      z-index:3;
      background:linear-gradient(180deg, var(--neon-orange), #ff8a33);
      color:#000;
      padding:10px 8px;
      text-align:center;
      cursor:pointer;
      user-select:none;
    }
    tbody td{
      padding:10px 8px;
      border-bottom:1px solid rgba(255,255,255,0.04);
      text-align:center;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    tbody tr:nth-child(even){background:var(--row-darker)}
    tbody tr:nth-child(odd){background:var(--row-dark)}
    .small{font-size:12px;color:var(--muted)}
    /* responsive */
    @media (max-width:900px){
      thead th, tbody td{font-size:12px;padding:8px}
    }
  </style>
</head>
<body>

  <h1>ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</h1>

  <div class="controls">
    <button class="btn" onclick="downloadExcel()">â¬‡ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ú©Ø³Ù„</button>
    <!-- Ø¨Ø¹Ø¯Ø§Ù‹ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø­Ø°Ù Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… -->
  </div>

  <div id="status">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§â€¦</div>

  <table id="logsTable" aria-label="Logs table">
    <thead>
      <tr id="tableHeader"></tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script>
    // Ù„ÛŒÙ†Ú© ÙˆØ¨â€ŒØ§Ù¾ Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª (Ø¨Ø¯ÙˆÙ† callback) â€” JSONP Ø¨Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† &callback=... Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    const apiBase = "https://script.google.com/macros/s/AKfycbwjHup4PINdXvx2WL4luUPHH4eVvEyJ-c7AUW3U5yc/dev?mode=getLogs";

    // ØªØ±ØªÛŒØ¨ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ Ùˆ Ø¹Ù†ÙˆØ§Ù† Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡â€ŒØ´Ø¯Ù‡ (Ø¨Ø³ØªÙ‡ Ø¨Ù‡ Ø®Ø±ÙˆØ¬ÛŒ doGet Ø´Ù…Ø§)
    const colKeys = [
      "table","duration","deviceType","browser","os",
      "screen","lang","referrer","items","total","recipient"
    ];
    const colLabels = {
      table: "Table",
      duration: "Duration (sec)",
      deviceType: "Device Type",
      browser: "Browser",
      os: "OS",
      screen: "Screen Resolution",
      lang: "Language",
      referrer: "Referrer",
      items: "Ordered Items",
      total: "Total Amount",
      recipient: "Recipient"
    };

    let logsData = [];
    let sortDirection = {}; // Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø³ØªÙˆÙ†: "asc" ÛŒØ§ "desc"
    const statusEl = document.getElementById("status");

    // === ØªØ§Ø¨Ø¹ JSONP Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡ (Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† fetch Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ± Ø²Ø¯Ù† CORS) ===
    function fetchLogsJSONP(timeoutMs = 10000) {
      statusEl.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ ÙˆØ¨â€ŒØ§Ù¾ Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØªâ€¦";
      const callbackName = "_gLogsCallback_" + Date.now();
      // Ø§ÛŒØ¬Ø§Ø¯ callback Ø³Ø±Ø§Ø³Ø±ÛŒ
      window[callbackName] = function(data) {
        clearTimeout(timeoutId);
        cleanup();
        if (!Array.isArray(data)) data = [];
        logsData = data;
        statusEl.textContent = "Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯. Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§: " + logsData.length;
        renderTable(logsData);
      };

      // Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§/Timeout
      const onError = () => {
        cleanup();
        statusEl.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ â€” Ù…Ù…Ú©Ù† Ø§Ø³Øª ÙˆØ¨â€ŒØ§Ù¾ Ù‚Ø§Ø¨Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¨Ø§Ø´Ø¯ ÛŒØ§ Ù¾Ø§Ø³Ø® Ù…Ø¹ÛŒÙˆØ¨ Ø¨Ø§Ø´Ø¯.";
        console.error("JSONP load failed");
      };

      // Ø§ÛŒØ¬Ø§Ø¯ ØªÚ¯ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª
      const script = document.createElement("script");
      script.id = callbackName;
      script.src = apiBase + "&callback=" + callbackName;
      script.onerror = onError;
      document.body.appendChild(script);

      // timeout
      const timeoutId = setTimeout(() => {
        onError();
      }, timeoutMs);

      // Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ callback Ùˆ ØªÚ¯ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ø¬Ø±Ø§ ÛŒØ§ Ø®Ø·Ø§
      function cleanup() {
        try{ delete window[callbackName]; }catch(e){ window[callbackName]=undefined; }
        const s = document.getElementById(callbackName);
        if (s && s.parentNode) s.parentNode.removeChild(s);
        clearTimeout(timeoutId);
      }
    }

    // === Ø±Ù†Ø¯Ø± Ø¬Ø¯ÙˆÙ„ ===
    function renderTable(data) {
      const headerRow = document.getElementById("tableHeader");
      const body = document.getElementById("tableBody");
      headerRow.innerHTML = "";
      body.innerHTML = "";

      if (!data || data.length === 0) {
        body.innerHTML = "<tr><td colspan='" + colKeys.length + "' class='small'>Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</td></tr>";
        return;
      }

      // Ø³Ø§Ø®Øª Ù‡Ø¯Ø± Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ
      colKeys.forEach(key => {
        const th = document.createElement("th");
        th.textContent = colLabels[key] || key;
        th.title = "Ø¨Ø±Ø§ÛŒ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯";
        th.onclick = () => sortTable(key);
        headerRow.appendChild(th);
      });

      // Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§
      data.forEach((rowObj, idx) => {
        const tr = document.createElement("tr");
        colKeys.forEach(key => {
          const td = document.createElement("td");
          let v = rowObj[key];
          if (v === null || v === undefined) v = "";
          td.textContent = v;
          tr.appendChild(td);
        });
        body.appendChild(tr);
      });
    }

    // === Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ ØªØ´Ø®ÛŒØµ Ø¹Ø¯Ø¯ÛŒ/Ù…ØªÙ†ÛŒ ===
    function sortTable(column) {
      const dir = sortDirection[column] === "asc" ? "desc" : "asc";
      sortDirection[column] = dir;

      logsData.sort((a,b) => {
        let A = a[column];
        let B = b[column];

        // ØªØ´Ø®ÛŒØµ Ø¹Ø¯Ø¯ÛŒ
        const aNum = parseFloat(String(A).replace(/[^\d.-]/g,""));
        const bNum = parseFloat(String(B).replace(/[^\d.-]/g,""));
        const bothNum = !isNaN(aNum) && !isNaN(bNum);

        if (bothNum) {
          return dir === "asc" ? (aNum - bNum) : (bNum - aNum);
        } else {
          // Ù…Ù‚Ø§ÛŒØ³Ù‡ Ù„ÙˆÚ©Ø§Ù„Ø§ÛŒØ²Ø¯ Ø±Ø´ØªÙ‡â€ŒØ§ÛŒ
          A = String(A || "").toLowerCase();
          B = String(B || "").toLowerCase();
          if (A < B) return dir === "asc" ? -1 : 1;
          if (A > B) return dir === "asc" ? 1 : -1;
          return 0;
        }
      });

      renderTable(logsData);
      statusEl.textContent = `Ù…Ø±ØªØ¨ Ø´Ø¯ Ø¨Ø± Ø§Ø³Ø§Ø³ "${colLabels[column] || column}" (${dir}) â€” Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§: ${logsData.length}`;
    }

    // === Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ú©Ø³Ù„ Ø¨Ø§ SheetJS ===
    function downloadExcel() {
      if (!logsData || logsData.length === 0) {
        alert("Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.");
        return;
      }
      // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¢Ø±Ø§ÛŒÙ‡â€ŒØ§ÛŒ Ø§Ø² Ø§Ø´ÛŒØ§Ø¡ Ø¨Ø§ Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ø®ÙˆØ§Ù†Ø§ (Ø¹Ù†ÙˆØ§Ù† Ø³ØªÙˆÙ†â€ŒÙ‡Ø§)
      const out = logsData.map(row => {
        const obj = {};
        colKeys.forEach(k => obj[colLabels[k] || k] = row[k]);
        return obj;
      });
      const ws = XLSX.utils.json_to_sheet(out);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Logs");
      XLSX.writeFile(wb, "restaurant_logs.xlsx");
    }

    // Ø§Ø¬Ø±Ø§ÛŒ JSONP Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
    fetchLogsJSONP();

    // (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) ØªØ§Ø¨Ø¹ Ø¹Ù…ÙˆÙ…ÛŒ Ø¨Ø±Ø§ÛŒ Ø±ÛŒÙÙØ±Ø´ Ø¯Ø³ØªÛŒ
    window.refreshLogs = () => { statusEl.textContent = "Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯â€¦"; fetchLogsJSONP(); };
  </script>
</body>
</html>
