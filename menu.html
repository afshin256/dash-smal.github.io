<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TOUCAN - Ù…Ù†Ùˆ</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    /* Ù¾Ø§ÛŒÙ‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ùˆ Ø´Ø¨Ú©Ù‡ */
    body { font-family: 'Segoe UI','Helvetica Neue',Tahoma,Arial; background:#0b0b0b; color:#eee; margin:0; padding:0 12px 80px 12px; }
    .header { padding:12px 0; display:flex; align-items:center; gap:12px; }
    .brand { display:flex; align-items:center; gap:10px; }
    .logo { width:44px;height:44px;border-radius:8px;background:#222;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px;color:#fff; }
    /* Ø´Ø¨Ú©Ù‡ ØºØ°Ø§Ù‡Ø§ */
    .food-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
    }
    @media (max-width:768px) {
      .food-grid {
        grid-template-columns: 1fr;
        gap: 6px;
      }
      body { padding-bottom: 120px; }
    }
    /* Ú©Ø§Ø±Øª ØºØ°Ø§ */
    .food-card {
      background: #111;
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 2px;
      align-items: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
    }
    /* ØªØµÙˆÛŒØ± ØºØ°Ø§ */
    .food-img {
      position: relative;
      width: 100%;
      aspect-ratio: 3 / 4;
      border-radius: 8px 8px 0 0;
      overflow: hidden;
      background: #222;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      border: 1px solid #222;
    }
    @media (max-width: 768px) {
      .food-img {
        aspect-ratio: 16 / 9;
      }
    }
    @media (min-width: 769px) {
      .food-img {
        height: 200px;
      }
    }
    .food-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      border-radius: inherit;
    }
    /* Ø¨Ø±Ú†Ø³Ø¨ ØªØ®ÙÛŒÙ */
    .discount-badge {
      position: absolute;
      bottom: 5px;
      right: 5px;
      background-color: #e63946;
      color: white;
      font-weight: bold;
      font-size: 12px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 10px rgba(230, 57, 70, 0.5);
      animation: pulse 2s infinite ease-in-out;
      z-index: 1;
      pointer-events: none;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    @media (max-width: 768px) {
      .discount-badge {
        width: 35px;
        height: 35px;
        font-size: 11px;
        bottom: 4px;
        right: 4px;
      }
    }
    /* Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØºØ°Ø§ */
    .food-info {
      flex: 1;
      min-width: 0;
      width: 100%;
      padding: 8px 10px;
    }
    .food-info h3 {
      margin: 0 0 6px 0;
      font-size: 16px;
      line-height: 1.2;
      color: #fff;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .food-info p {
      margin: 0 0 6px 0;
      font-size: 13px;
      color: #bbb;
      white-space: normal;
      word-wrap: break-word;
    }
    /* ÙÙˆØªØ± Ø¬Ø¯ÛŒØ¯ */
    .food-footer {
      width: 100%;
      height: 40px;
      background-color: #111;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 10px;
      border-radius: 0 0 12px 12px;
    }
    .price {
      font-weight: 800;
      min-width: 90px;
      font-size: 14px;
      color: #ffb84d;
      text-align: right;
      direction: ltr;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      line-height: 1.1;
    }
    .price del {
      color: #999;
      font-size: 13px;
      text-decoration: line-through;
      order: 1;
    }
    .price .discounted {
      color: #e63946;
      font-size: 16px;
      font-weight: bold;
      order: 2;
    }
    .add-btn {
      background: #c62828;
      border: none;
      color: #fff;
      padding: 6px 8px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .food-card:hover {
      transform: translateY(-10px) scale(1.05);
      animation: flame 1.5s infinite alternate ease-in-out;
      z-index: 10;
    }
    @keyframes flame {
      0% {
        box-shadow: 
          0 0 10px 5px rgba(255, 69, 0, 0.7),
          0 0 20px 10px rgba(255, 140, 0, 0.5),
          0 0 30px 15px rgba(255, 215, 0, 0.3);
      }
      33% {
        box-shadow: 
          0 0 15px 7px rgba(255, 69, 0, 0.8),
          0 0 25px 12px rgba(255, 140, 0, 0.6),
          0 0 35px 17px rgba(255, 215, 0, 0.4);
      }
      66% {
        box-shadow: 
          0 0 12px 6px rgba(255, 69, 0, 0.6),
          0 0 22px 11px rgba(255, 140, 0, 0.4),
          0 0 32px 16px rgba(255, 215, 0, 0.2);
      }
      100% {
        box-shadow: 
          0 0 10px 5px rgba(255, 69, 0, 0.7),
          0 0 20px 10px rgba(255, 140, 0, 0.5),
          0 0 30px 15px rgba(255, 215, 0, 0.3);
      }
    }
    /* Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù†Ø§ÙˆØ± */
    .cart-floating {
      position: fixed;
      right: 12px;
      bottom: 12px;
      width: 360px;
      max-width: calc(100% - 24px);
      background: linear-gradient(180deg, rgba(10,10,10,0.95), rgba(12,12,12,0.95));
      color: #fff;
      padding: 14px 14px 44px 86px;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 1100;
      min-width: 280px;
      font-size: 13px;
    }
    .cart-list {
      max-height: 160px;
      overflow: auto;
      padding-right: 6px;
    }
    .cart-item {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.04);
    }
    .cart-item .qty {
      font-weight: 800;
      width: 48px;
      text-align: center;
    }
    .cart-item button {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.06);
      color: #fff;
      padding: 4px 6px;
      border-radius: 6px;
      cursor: pointer;
    }
    .cart-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
    }
    .send-btn {
      background: #0ea5b7;
      border: none;
      color: #fff;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 800;
    }
    .send-btn[style] {
      /* allow inline override */
    }
    /* Ø¯Ú©Ù…Ù‡ Ù…ÙˆØ²ÛŒÚ© */
    .music-button {
      position: absolute;
      left: 12px;
      top: 12px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid rgba(255,255,255,0.06);
      background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1200;
      transition: box-shadow 0.1s ease;
    }
    .music-button img {
      width: 86%;
      height: 86%;
      object-fit: contain;
      display: block;
    }
    .rights-text {
      position: absolute;
      bottom: 8px;
      left: 0;
      right: 0;
      text-align: center;
      font-weight: 800;
      color: #fff;
      font-size: 12px;
      pointer-events: none;
    }
    @media (max-width: 420px) {
      .cart-floating {
        right: 8px;
        left: 8px;
        width: auto;
        padding-left: 82px;
      }
      .music-button {
        left: 8px;
      }
    }
    /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ intro overlay */
    #intro-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }
    #intro-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .gif-container {
      width: 80%;
      max-width: 400px;
      text-align: center;
    }
    #intro-gif {
      width: 100%;
      height: auto;
    }
    .intro-blurred {
      filter: blur(5px);
      transition: filter 0.5s ease;
    }

    /* Ø§Ø³ØªØ§ÛŒÙ„ Ù…ÙˆØ¯Ø§Ù„ ØªØ­ÙˆÛŒÙ„ */
    #delivery-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 3000;
      align-items: center;
      justify-content: center;
    }
    #delivery-modal-content {
      background: #111;
      color: #fff;
      width: 90%;
      max-width: 500px;
      border-radius: 12px;
      padding: 20px;
      position: relative;
    }
    #delivery-modal-content input,
    #delivery-modal-content textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      background: #222;
      color: #fff;
      border: 1px solid #444;
      box-sizing: border-box;
    }
    #delivery-modal-content textarea {
      resize: vertical;
      min-height: 80px;
    }
    .payment-option {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 8px 0;
    }
    .payment-option.disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    .cart-preview-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 0;
      border-bottom: 1px solid #333;
    }
    .cart-preview-item img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <!-- intro GIF overlay -->
  <div id="intro-overlay">
    <div class="gif-container">
      <img id="intro-gif" src="https://www.dash-smal.ir/assets/images/777.gif" alt="Ù„ÙˆÚ¯Ùˆ Ù…ÙˆØ´Ù†">
    </div>
  </div>
  <div id="main-content">
    <div class="header">
      <div class="brand">
        <div class="logo">T</div>
        <div>
          <div style="font-weight:800;font-size:18px">TOUCAN</div>
          <div style="font-size:13px;color:#bbb">Ù…Ù†ÙˆÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„ - Ø³ÙØ§Ø±Ø´ Ø¨Ø§ QR</div>
        </div>
      </div>
    </div>
    <div>
      <div style="margin-bottom:10px">
        <strong>Ù…ÛŒØ²:</strong> <span id="table-number-display">â€”</span>
      </div>
      <div id="food-grid" class="food-grid"></div>
    </div>
    <!-- floating cart -->
    <div id="cart" class="cart-floating" aria-live="polite">
      <button id="music-toggle" class="music-button" title="Ù¾Ø®Ø´/ØªÙˆÙ‚Ù Ù…ÙˆØ³ÛŒÙ‚ÛŒ">
        <img id="music-icon" src="https://www.dash-smal.ir/assets/images/player/play.png" alt="play">
      </button>
      <div style="flex:1">
        <div style="font-weight:800; margin-bottom:6px">ÙØ§Ú©ØªÙˆØ± (<span id="cart-count">0</span>)</div>
        <div class="cart-list" id="cart-list"></div>
        <div style="margin-top:6px;font-weight:800">Ú©Ù„: <span id="cart-total">0</span> ØªÙˆÙ…Ø§Ù†</div>
      </div>
      <div class="cart-actions">
        <button id="send-whatsapp" class="send-btn">Ø§Ø±Ø³Ø§Ù„ Ø³ÙØ§Ø±Ø´ Ø§Ø² Ø·Ø±ÛŒÙ‚ ÙˆØ§ØªØ³â€ŒØ§Ù¾</button>
        <button id="clear-cart" class="send-btn" style="background:#eee;color:#000">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
      </div>
      <div class="rights-text">All rights reserved by Dash Smal Content Production Agency.</div>
    </div>
    <!-- Ù¾Ù„ÛŒØ± Ù¾Ù†Ù‡Ø§Ù† -->
    <audio id="background-music" src="https://www.dash-smal.ir/assets/music/toucan/toucan.mp3" loop preload="none"></audio>
    <!-- modal Ù‚Ø¨Ù„ÛŒ -->
    <div id="modal" class="modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:2000">
      <div class="box" role="dialog" aria-modal="true" style="background:#111;color:#fff;padding:16px;border-radius:10px;max-width:92%;width:420px">
        <h3 style="margin-top:0">Ú†Ù†Ø¯ Ø´Ù…Ø§Ø±Ù‡ Ø¢Ø´Ù¾Ø²Ø®Ø§Ù†Ù‡ Ù¾ÛŒØ¯Ø§ Ø´Ø¯</h3>
        <p style="color:#ccc">Ø³ÙØ§Ø±Ø´ Ø¨Ù‡ Ù‡Ø± Ø´Ù…Ø§Ø±Ù‡ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯. Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ù‡Ù…Ù‡ Ø±Ø§ Ø¨Ø§ Ù‡Ù… Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.</p>
        <div id="recipient-list" style="display:flex;flex-direction:column;gap:8px;margin-top:12px"></div>
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-start">
          <button id="send-all" class="send-btn">Ø§Ø±Ø³Ø§Ù„ Ù‡Ù…Ù‡</button>
          <button id="close-modal" class="send-btn" style="background:#ddd;color:#000">Ø¨Ø³ØªÙ†</button>
        </div>
      </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØªØ­ÙˆÛŒÙ„ -->
    <div id="delivery-modal">
      <div id="delivery-modal-content">
        <h3 style="margin-top:0;text-align:center">ØªØ­ÙˆÛŒÙ„ Ø³ÙØ§Ø±Ø´</h3>
        <div id="modal-cart-preview" style="max-height:180px;overflow:auto;margin-bottom:16px"></div>
        <div style="display:flex;flex-direction:column;gap:12px">
          <input type="text" id="delivery-name" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ *" />
          <textarea id="delivery-address" placeholder="Ø¢Ø¯Ø±Ø³ Ø¯Ù‚ÛŒÙ‚ ØªØ­ÙˆÛŒÙ„ *"></textarea>
          <div style="margin:12px 0">
            <div class="payment-option">
              <input type="radio" name="payment" value="cash" checked id="pay-cash">
              <label for="pay-cash">Ù¾Ø±Ø¯Ø§Ø®Øª Ø¯Ø± Ù…Ø­Ù„</label>
            </div>
            <div class="payment-option disabled">
              <input type="radio" name="payment" value="online" disabled id="pay-online">
              <label for="pay-online">Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢Ù†Ù„Ø§ÛŒÙ† (Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ)</label>
            </div>
          </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:16px">
          <button id="submit-delivery" class="send-btn" disabled>Ø§Ø±Ø³Ø§Ù„ Ø³ÙØ§Ø±Ø´</button>
          <button id="cancel-delivery" style="background:#555">Ù„ØºÙˆ</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* menu.js - client side logic */
(() => {
  const CSV_PATH = 'data/foods.csv';
  const REPORT_PATH = 'data/report.csv';
  const PLACEHOLDER = 'assets/images/placeholder.png';
  const POLL_INTERVAL = 12000;

  const table = getQueryParam('table') || localStorage.getItem('toucan_table') || 'â€”';
  document.getElementById('table-number-display').textContent = table;
  localStorage.setItem('toucan_table', table);
  let foods = [];
  let cart = {};
  let audioCtx, source, analyser, bufferLength, dataArray;
  const neonColors = [
    {r: 0, g: 255, b: 255},
    {r: 255, g: 105, b: 180},
    {r: 138, g: 43, b: 226}
  ];
  let currentNeonIndex = 0;
  let nextChangeTime = Date.now() + 5000;
  let transitionStartTime = 0;
  let transitionDuration = 1000;
  let isFadingOut = false;
  let currentAlpha = 0.6;

  // ========== Google Sheets Logger ==========
  const SHEET_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyHOywAqL48GvQq2t3X9gI-32ToWgolaifVEaGtdw6vpHiMZtAptpwH1Vr4rnjb8Wak/exec";
  let visitStartTime = Date.now();
  function getDeviceType() {
    const ua = navigator.userAgent;
    if (/android/i.test(ua)) return "Android";
    if (/iPad|iPhone|iPod/.test(ua)) return "iOS";
    if (/Win/.test(ua)) return "Windows";
    if (/Mac/.test(ua)) return "Mac";
    if (/Linux/.test(ua)) return "Linux";
    return "Unknown";
  }
  function getBrowser() {
    const ua = navigator.userAgent;
    if (ua.includes("Chrome") && !ua.includes("Edg")) return "Chrome";
    if (ua.includes("Firefox")) return "Firefox";
    if (ua.includes("Safari") && !ua.includes("Chrome")) return "Safari";
    if (ua.includes("Edg")) return "Edge";
    return "Other";
  }
  function getOS() {
    const ua = navigator.userAgent;
    if (ua.includes("Win")) return "Windows";
    if (ua.includes("Mac")) return "macOS";
    if (ua.includes("Linux")) return "Linux";
    if (ua.includes("Android")) return "Android";
    if (ua.includes("iPhone") || ua.includes("iPad")) return "iOS";
    return "Unknown";
  }
  function getOrderedItemsAsString() {
    const items = [];
    for (const id in cart) {
      const it = cart[id];
      if (it.qty > 0) {
        items.push(`${it.qty}x ${it.fa || it.en}`);
      }
    }
    return items.join("; ");
  }
  function logToSheet(durationSec) {
    const data = {
      table: table || "â€”",
      duration: Math.round(durationSec),
      deviceType: getDeviceType(),
      browser: getBrowser(),
      os: getOS(),
      screen: `${screen.width}x${screen.height}`,
      lang: navigator.language || "unknown",
      referrer: document.referrer || "direct",
      items: getOrderedItemsAsString(),
      total: document.getElementById('cart-total')?.textContent?.replace(/,/g, '') || "0",
      recipient: "N/A"
    };
    try {
      fetch(SHEET_WEB_APP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify(data)
      });
    } catch (e) {}
  }
  // ========== Ø§Ù†ØªÙ‡Ø§ÛŒ Logger ==========

  function getQueryParam(name) {
    const params = new URLSearchParams(location.search);
    return params.get(name);
  }

  function parseCSV(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
    if(lines.length === 0) return [];
    function parseLine(line) {
      const res=[]; let cur=''; let inQ=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch==='"'){
          if(inQ && line[i+1]==='"'){ cur+='"'; i++; }
          else inQ=!inQ;
        } else if(ch===',' && !inQ){
          res.push(cur); cur='';
        } else { cur+=ch; }
      }
      res.push(cur);
      return res;
    }
    const parsed = lines.map(parseLine);
    return parsed;
  }

  function parseCSVLine(line) {
    const res = [];
    let cur = '';
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        if (inQuotes && line[i + 1] === '"') {
          cur += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (ch === ',' && !inQuotes) {
        res.push(cur);
        cur = '';
      } else {
        cur += ch;
      }
    }
    res.push(cur);
    return res;
  }

  async function fetchFoods() {
    try {
      const resp = await fetch(CSV_PATH + '?t=' + Date.now());
      const text = await resp.text();
      const rows = parseCSV(text);
      foods = rows.map((r, idx) => {
        const price = r[3] ? Number(String(r[3]).replace(/[^0-9.-]/g,'')) : 0;
        const discountPercent = r[9] ? parseFloat(r[9]) || 0 : 0;
        const discountedPrice = discountPercent > 0 ? Math.round(price * (1 - discountPercent / 100)) : price;
        return {
          id: (r[0] || ('item-'+idx)).toString().trim() || ('item-'+idx),
          en: (r[0]||'').trim(),
          fa: (r[1]||'').trim(),
          ingredients: (r[2]||'').trim(),
          price: price,
          discountedPrice: discountedPrice,
          hasDiscount: discountPercent > 0,
          discountPercent: discountPercent,
          whatsapp: (r[4]||'').trim(),
          img_name: (r[5]||'').trim(),
          img_folder: (r[6]||'').trim()
        };
      }).filter(it => it.en || it.fa);
      reconcileCartWithFoods();
      renderFoods();
    } catch(e){
      console.error('failed to load CSV', e);
      document.getElementById('food-grid').innerHTML = '<p style="color: red;">Ø®Ø·Ø§ Ø¯Ø± Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ foods.csv</p>';
    }
  }

  async function fetchDeliveryWhatsApp() {
    try {
      const resp = await fetch(REPORT_PATH + '?t=' + Date.now());
      const text = await resp.text();
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
      if (lines.length >= 2) {
        const secondRow = lines[1];
        const columns = parseCSVLine(secondRow);
        if (columns.length >= 11) {
          return sanitizeNumber(columns[10]);
        }
      }
    } catch (e) {
      console.warn('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† report.csv:', e);
    }
    return null;
  }

  function reconcileCartWithFoods(){
    for(const key in cart){
      const entry = cart[key];
      const match = foods.find(f => f.id === entry.id || f.en === entry.en || f.fa === entry.fa);
      if(match){
        entry.price = match.price;
        entry.discountedPrice = match.discountedPrice;
        entry.hasDiscount = match.hasDiscount;
        entry.discountPercent = match.discountPercent;
        entry.en = match.en;
        entry.fa = match.fa;
        entry.whatsapp = match.whatsapp;
        entry.img_folder = match.img_folder;
        entry.img_name = match.img_name;
      } else {
        entry.removed = true;
      }
    }
    saveCart();
    renderCart();
  }

  function renderFoods(){
    const grid = document.getElementById('food-grid');
    grid.innerHTML = '';
    foods.forEach(f => {
      const card = document.createElement('div');
      card.className = 'food-card';
      card.dataset.id = f.id;
      const imgWrap = document.createElement('div'); imgWrap.className='food-img';
      const img = document.createElement('img');
      const imgPath = makeImagePath(f);
      img.src = imgPath;
      img.onerror = () => img.src = PLACEHOLDER;
      img.alt = f.fa || f.en;
      imgWrap.appendChild(img);
      if (f.hasDiscount) {
        const badge = document.createElement('div');
        badge.className = 'discount-badge';
        badge.textContent = `${Math.round(f.discountPercent)}%`;
        imgWrap.appendChild(badge);
      }
      const info = document.createElement('div'); info.className='food-info';
      const h = document.createElement('h3');
      h.textContent = f.fa || f.en;
      info.appendChild(h);
      const p = document.createElement('p'); p.textContent = f.ingredients || '';
      info.appendChild(p);
      const footer = document.createElement('div'); 
      footer.className = 'food-footer';
      const priceSpan = document.createElement('div');
      priceSpan.className = 'price';
      if (f.hasDiscount) {
        const original = document.createElement('del');
        original.textContent = formatMoney(f.price);
        const discounted = document.createElement('span');
        discounted.className = 'discounted';
        discounted.textContent = formatMoney(f.discountedPrice);
        priceSpan.appendChild(original);
        priceSpan.appendChild(discounted);
      } else {
        priceSpan.textContent = formatMoney(f.price) + ' ØªÙˆÙ…Ø§Ù†';
      }
      const addBtn = document.createElement('button');
      addBtn.className = 'add-btn';
      addBtn.textContent = '+';
      addBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        addToCart(f);
      });
      footer.appendChild(addBtn);
      footer.appendChild(priceSpan);
      card.appendChild(imgWrap);
      card.appendChild(info);
      card.appendChild(footer);
      grid.appendChild(card);
    });
  }

  function makeImagePath(f){
    let folder = (f.img_folder || '').trim();
    let name = (f.img_name || '').trim();
    if(folder && name){
      folder = folder.replace(/\s+$/,'').replace(/\\/g,'/').replace(/\s+/g,' ');
      let path = folder + (folder.endsWith('/') ? '' : '/') + name;
      return encodeURI(path);
    }
    return PLACEHOLDER;
  }

  function formatMoney(num){
    if(!num && num !== 0) return '0';
    try{
      return Number(num).toLocaleString('en-US');
    }catch(e){ return String(num); }
  }

  function addToCart(food){
    const id = food.id || (food.en||food.fa).toString().trim();
    if(!cart[id]) cart[id] = Object.assign({}, food, {qid:id, qty:0});
    cart[id].qty += 1;
    delete cart[id].removed;
    saveCart();
    renderCart();
  }

  function removeFromCart(id){
    delete cart[id];
    saveCart();
    renderCart();
  }

  function changeQty(id, delta){
    if(!cart[id]) return;
    cart[id].qty += delta;
    if(cart[id].qty <= 0) delete cart[id];
    saveCart();
    renderCart();
  }

  function saveCart(){
    try{
      localStorage.setItem('toucan_cart', JSON.stringify(cart));
    }catch(e){}
  }

  function loadCart(){
    try{
      const raw = localStorage.getItem('toucan_cart');
      if(raw) cart = JSON.parse(raw);
    }catch(e){ cart = {}; }
  }

  function clearCart(){
    cart = {};
    saveCart();
    renderCart();
  }

  function renderCart(){
    const list = document.getElementById('cart-list');
    list.innerHTML = '';
    let total = 0, count = 0;
    for(const id in cart){
      const it = cart[id];
      count += it.qty;
      total += (Number(it.discountedPrice || it.price)||0) * it.qty;
      const row = document.createElement('div'); row.className='cart-item';
      const name = document.createElement('div'); name.style.flex='1'; name.textContent = (it.fa||it.en) + (it.removed ? ' (Ø­Ø°Ùâ€ŒØ´Ø¯Ù‡ Ø§Ø² Ù…Ù†Ùˆ)' : '');
      const qty = document.createElement('div'); qty.className='qty'; qty.textContent = it.qty + 'x';
      const plus = document.createElement('button'); plus.textContent='+'; plus.addEventListener('click', ()=> changeQty(id,1));
      const minus = document.createElement('button'); minus.textContent='-'; minus.addEventListener('click', ()=> changeQty(id,-1));
      const rem = document.createElement('button'); rem.textContent='Ø­Ø°Ù'; rem.addEventListener('click', ()=> removeFromCart(id));
      row.appendChild(name); row.appendChild(qty); row.appendChild(plus); row.appendChild(minus); row.appendChild(rem);
      list.appendChild(row);
    }
    document.getElementById('cart-total').textContent = formatMoney(total);
    document.getElementById('cart-count').textContent = count;
  }

  function buildMessages(){
    const groups = {};
    for(const id in cart){
      const it = cart[id];
      if(!it.whatsapp) it.whatsapp = '';
      const num = sanitizeNumber(it.whatsapp || '');
      const key = num || '__NO_NUM__';
      if(!groups[key]) groups[key] = {num: num, items: [], subtotal:0};
      groups[key].items.push(it);
      groups[key].subtotal += (Number(it.discountedPrice || it.price)||0) * it.qty;
    }
    const messages = [];
    for(const k in groups){
      const g = groups[k];
      let lines = [];
      lines.push('Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯ - TOUCAN');
      lines.push('Ù…ÛŒØ²: ' + (table || 'â€”'));
      lines.push('');
      g.items.forEach(it => {
        lines.push(it.qty + ' x ' + (it.fa||it.en) + ' - ' + formatMoney(it.discountedPrice || it.price) + ' ØªÙˆÙ…Ø§Ù†');
      });
      lines.push('');
      lines.push('Ù…Ø¬Ù…ÙˆØ¹: ' + formatMoney(g.subtotal) + ' ØªÙˆÙ…Ø§Ù†');
      const txt = lines.join('\n');
      messages.push({to: g.num, text: txt, items: g.items, subtotal: g.subtotal});
    }
    return messages;
  }

  function sanitizeNumber(n){
    if(!n) return '';
    return String(n).replace(/[^0-9]/g,'');
  }

  function sendToWhatsApp(){
    const msgs = buildMessages();
    if(msgs.length === 0) { alert('Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª'); return; }
    if(msgs.length === 1){
      const m = msgs[0];
      if(!m.to){ promptAndOpen(m.text); saveOrderForKitchen(m); }
      else { const url = 'https://wa.me/' + m.to + '?text=' + encodeURIComponent(m.text); window.open(url, '_blank'); saveOrderForKitchen(m); }
      return;
    }
    const modal = document.getElementById('modal');
    const list = document.getElementById('recipient-list');
    list.innerHTML = '';
    msgs.forEach(m => {
      const div = document.createElement('div');
      div.style.display = 'flex';
      div.style.justifyContent = 'space-between';
      div.style.alignItems = 'center';
      div.style.gap = '8px';
      div.style.padding = '6px 0';
      const label = document.createElement('div'); label.textContent = (m.to || '(Ø¨Ø¯ÙˆÙ† Ø´Ù…Ø§Ø±Ù‡)') + ' â€” Ù…Ø¬Ù…ÙˆØ¹: ' + formatMoney(m.subtotal) + ' ØªÙˆÙ…Ø§Ù†';
      const btn = document.createElement('button'); btn.className='send-btn'; btn.textContent='Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ' + (m.to || '(ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯)');
      btn.addEventListener('click', ()=> {
        if(!m.to) { promptAndOpen(m.text); saveOrderForKitchen(m); }
        else { window.open('https://wa.me/' + m.to + '?text=' + encodeURIComponent(m.text), '_blank'); saveOrderForKitchen(m); }
      });
      div.appendChild(label); div.appendChild(btn);
      list.appendChild(div);
    });
    modal.style.display = 'flex';
    document.getElementById('close-modal').onclick = ()=> modal.style.display='none';
    document.getElementById('send-all').onclick = ()=> {
      msgs.forEach(m=>{
        if(m.to) window.open('https://wa.me/' + m.to + '?text=' + encodeURIComponent(m.text), '_blank');
        else promptAndOpen(m.text);
        saveOrderForKitchen(m);
      });
    };
  }

  function promptAndOpen(text){
    const number = prompt('Ø´Ù…Ø§Ø±Ù‡ ÙˆØ§ØªØ³â€ŒØ§Ù¾ Ø¢Ø´Ù¾Ø²Ø®Ø§Ù†Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 98912...)');
    if(number){
      const num = sanitizeNumber(number);
      window.open('https://wa.me/' + num + '?text=' + encodeURIComponent(text), '_blank');
    } else {
      alert('Ø´Ù…Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯.');
    }
  }

  function saveOrderForKitchen(message){
    try{
      const raw = localStorage.getItem('toucan_orders') || '[]';
      const orders = JSON.parse(raw);
      orders.unshift({to: message.to, text: message.text, items: message.items, subtotal: message.subtotal, table: table, ts: Date.now()});
      localStorage.setItem('toucan_orders', JSON.stringify(orders.slice(0,200)));
    }catch(e){ console.warn(e); }
  }

  function isNumeric(str) {
    return /^\d+$/.test(str);
  }

  function openDeliveryModal() {
    const preview = document.getElementById('modal-cart-preview');
    preview.innerHTML = '';
    let hasItems = false;
    for (const id in cart) {
      const it = cart[id];
      if (it.qty <= 0) continue;
      hasItems = true;
      const div = document.createElement('div');
      div.className = 'cart-preview-item';
      const img = document.createElement('img');
      img.src = makeImagePath(it);
      img.onerror = () => img.src = PLACEHOLDER;
      const info = document.createElement('div');
      info.innerHTML = `<strong>${it.qty}x ${it.fa || it.en}</strong><br><small>${formatMoney(it.discountedPrice || it.price)} ØªÙˆÙ…Ø§Ù†</small>`;
      div.appendChild(img);
      div.appendChild(info);
      preview.appendChild(div);
    }
    if (!hasItems) {
      alert('Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.');
      return;
    }
    document.getElementById('delivery-modal').style.display = 'flex';
    setupDeliveryFormValidation();
  }

  function setupDeliveryFormValidation() {
    const nameInput = document.getElementById('delivery-name');
    const addressInput = document.getElementById('delivery-address');
    const submitBtn = document.getElementById('submit-delivery');

    function validate() {
      const name = nameInput.value.trim();
      const address = addressInput.value.trim();
      submitBtn.disabled = !(name && address);
    }

    nameInput.addEventListener('input', validate);
    addressInput.addEventListener('input', validate);

    document.getElementById('cancel-delivery').onclick = () => {
      document.getElementById('delivery-modal').style.display = 'none';
    };

    submitBtn.onclick = async () => {
      const name = nameInput.value.trim();
      const address = addressInput.value.trim();
      const payment = 'Ù¾Ø±Ø¯Ø§Ø®Øª Ø¯Ø± Ù…Ø­Ù„';

      let lines = [];
      lines.push('ğŸ“¦ Ø³ÙØ§Ø±Ø´ Ø¢Ù†Ù„Ø§ÛŒÙ† - TOUCAN');
      lines.push('Ù…ÛŒØ²: ' + (table || 'â€”'));
      lines.push('ØªØ­ÙˆÛŒÙ„â€ŒÚ¯ÛŒØ±Ù†Ø¯Ù‡: ' + name);
      lines.push('Ø¢Ø¯Ø±Ø³: ' + address);
      lines.push('Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: ' + payment);
      lines.push('');
      lines.push('--- Ø³ÙØ§Ø±Ø´Ø§Øª ---');
      for (const id in cart) {
        const it = cart[id];
        if (it.qty > 0) {
          lines.push(`${it.qty} x ${it.fa || it.en} - ${formatMoney(it.discountedPrice || it.price)} ØªÙˆÙ…Ø§Ù†`);
        }
      }
      const total = document.getElementById('cart-total').textContent;
      lines.push('');
      lines.push('Ù…Ø¬Ù…ÙˆØ¹: ' + total + ' ØªÙˆÙ…Ø§Ù†');

      const message = lines.join('\n');

      const deliveryNumber = await fetchDeliveryWhatsApp();
      if (!deliveryNumber || deliveryNumber.length < 8) {
        alert('âš ï¸ Ø´Ù…Ø§Ø±Ù‡ ÙˆØ§ØªØ³â€ŒØ§Ù¾ ØªØ­ÙˆÛŒÙ„ Ø¯Ø± ÙØ§ÛŒÙ„ report.csv ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.');
        return;
      }

      const url = 'https://wa.me/' + deliveryNumber + '?text=' + encodeURIComponent(message);
      window.open(url, '_blank');

      cart = {};
      saveCart();
      renderCart();
      document.getElementById('delivery-modal').style.display = 'none';
      nameInput.value = '';
      addressInput.value = '';
    };
  }

  // ========== Ù¾Ø®Ø´ Ù…ÙˆØ³ÛŒÙ‚ÛŒ ==========
  const music = document.getElementById('background-music');
  const toggleBtn = document.getElementById('music-toggle');
  const icon = document.getElementById('music-icon');
  const PLAY_SRC = "https://www.dash-smal.ir/assets/images/player/play.png";
  const PAUSE_SRC = "https://www.dash-smal.ir/assets/images/player/puse.png";
  icon.src = PLAY_SRC;
  toggleBtn.addEventListener('click', async (ev) => {
    ev.preventDefault();
    try {
      if (music.paused) {
        await music.play();
        icon.src = PAUSE_SRC;
        setupAudioAnalyzer();
        animateFlame();
      } else {
        music.pause();
        icon.src = PLAY_SRC;
      }
    } catch (err) {
      alert('Ø¨Ø±Ø§ÛŒ Ù¾Ø®Ø´ ØµØ¯Ø§ØŒ Ù„Ø·ÙØ§Ù‹ Ø±ÙˆÛŒ ØµÙØ­Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.');
    }
  });
  function setupAudioAnalyzer() {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      source = audioCtx.createMediaElementSource(music);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 256;
      bufferLength = analyser.frequencyBinCount;
      dataArray = new Uint8Array(bufferLength);
      source.connect(analyser);
      analyser.connect(audioCtx.destination);
    }
  }
  function animateFlame() {
    if (music.paused) return;
    analyser.getByteFrequencyData(dataArray);
    let avgLow = 0, avgMid = 0, avgHigh = 0;
    const third = Math.floor(bufferLength / 3);
    for (let i = 0; i < third; i++) avgLow += dataArray[i];
    for (let i = third; i < 2 * third; i++) avgMid += dataArray[i];
    for (let i = 2 * third; i < bufferLength; i++) avgHigh += dataArray[i];
    avgLow /= third;
    avgMid /= third;
    avgHigh /= (bufferLength - 2 * third);
    let intensityLow = (avgLow / 255) * 80;
    let intensityMid = (avgMid / 255) * 80;
    let intensityHigh = (avgHigh / 255) * 80;
    const now = Date.now();
    if (now >= nextChangeTime) {
      transitionStartTime = now;
      isFadingOut = true;
      nextChangeTime = now + 5000;
    }
    let neonShadow = '';
    if (transitionStartTime > 0) {
      const elapsed = now - transitionStartTime;
      if (isFadingOut) {
        currentAlpha = 0.6 * (1 - elapsed / transitionDuration);
        if (elapsed >= transitionDuration) {
          currentNeonIndex = (currentNeonIndex + 1) % neonColors.length;
          transitionStartTime = now;
          isFadingOut = false;
          currentAlpha = 0;
        }
      } else {
        currentAlpha = 0.6 * (elapsed / transitionDuration);
        if (elapsed >= transitionDuration) {
          transitionStartTime = 0;
        }
      }
    } else {
      currentAlpha = 0.6;
    }
    const neon = neonColors[currentNeonIndex];
    neonShadow = `0 0 ${intensityLow * 0.8}px 8px rgba(${neon.r}, ${neon.g}, ${neon.b}, ${currentAlpha}),
      0 0 ${intensityMid * 1.2}px 12px rgba(${neon.r}, ${neon.g}, ${neon.b}, ${currentAlpha}),
      0 0 ${intensityHigh * 1.6}px 16px rgba(${neon.r}, ${neon.g}, ${neon.b}, ${currentAlpha})`;
    toggleBtn.style.boxShadow = `0 0 ${intensityLow}px 3px rgba(255, 69, 0, 0.7),
      0 0 ${intensityMid * 1.5}px 3px rgba(255, 140, 0, 0.5),
      0 0 ${intensityHigh * 2}px 3px rgba(255, 215, 0, 0.3),
      ${neonShadow}`;
    requestAnimationFrame(animateFlame);
  }
  music.addEventListener('play', () => {
    icon.src = PAUSE_SRC;
    setupAudioAnalyzer();
    animateFlame();
  });
  music.addEventListener('pause', () => icon.src = PLAY_SRC);
  music.addEventListener('ended', () => icon.src = PLAY_SRC);

  // ========== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ==========
  loadCart();
  fetchFoods();
  renderCart();
  setInterval(fetchFoods, POLL_INTERVAL);

  // ========== Ù…Ù†Ø·Ù‚ Ø§Ø±Ø³Ø§Ù„ Ø³ÙØ§Ø±Ø´ ==========
  document.getElementById('send-whatsapp').addEventListener('click', () => {
    const duration = (Date.now() - visitStartTime) / 1000;
    logToSheet(duration);

    if (table !== 'â€”' && isNumeric(table)) {
      sendToWhatsApp();
      cart = {};
      saveCart();
      renderCart();
    } else {
      openDeliveryModal();
    }
  });

  document.getElementById('clear-cart').addEventListener('click', ()=> {
    if(confirm('Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø§Ù…Ù„ ÙØ§Ú©ØªÙˆØ±ØŸ')) clearCart();
  });

  document.getElementById('modal').addEventListener('click', (ev)=>{
    if(ev.target === document.getElementById('modal')) document.getElementById('modal').style.display='none';
  });

  document.addEventListener('DOMContentLoaded', () => {
    const overlay = document.getElementById('intro-overlay');
    const gif = document.getElementById('intro-gif');
    const mainContent = document.getElementById('main-content');
    mainContent.classList.add('intro-blurred');
    const gifDuration = 10000;
    setTimeout(dismissOverlay, gifDuration);
    document.addEventListener('click', dismissOverlay, { once: true });
    document.addEventListener('touchstart', dismissOverlay, { once: true });
    function dismissOverlay() {
      overlay.classList.add('hidden');
      mainContent.classList.remove('intro-blurred');
      gif.src = '';
    }
  });
})();
</script>
</body>
</html>
