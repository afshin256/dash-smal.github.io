<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TOUCAN - منو</title>

  <!-- CSS داخلی — کم‌حجم و بدون request جداگانه -->
  <style>
    /* --- CSS بهینه‌شده — تمام استایل در یک فایل --- */
    body {
      background-color: #070606;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    * { box-sizing: border-box; }

    .header {
      padding: 12px 16px;
      background: #111;
      border-bottom: 1px solid #333;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo {
      width: 40px;
      height: 40px;
      background: #ff9800;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
    }
    .food-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 12px;
      padding: 10px;
      margin-bottom: 120px;
    }
    .food-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      position: relative;
    }
    .food-img {
      width: 100%;
      height: 140px;
      object-fit: cover;
    }
    .food-info h3 {
      margin: 8px 0 4px;
      font-size: 16px;
      color: #000;
      text-align: center;
    }
    .food-info p {
      margin: 0 0 8px;
      font-size: 13px;
      color: #555;
      text-align: center;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      padding: 8px;
    }
    .price {
      color: #ffb84d;
      font-weight: bold;
      font-size: 15px;
    }
    .add-btn {
      background: yellow;
      color: black;
      border: none;
      padding: 6px 12px;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      font-size: 14px;
    }

    .cart-floating {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #333;
      color: white;
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      z-index: 100;
    }
    .cart-list {
      max-height: 100px;
      overflow-y: auto;
      margin-top: 8px;
    }
    .cart-item {
      display: flex;
      justify-content: space-between;
      background: #444;
      padding: 4px 8px;
      margin: 4px 0;
      border-radius: 5px;
      font-size: 14px;
    }
    .send-btn {
      background: yellow;
      color: black;
      border: none;
      padding: 10px;
      margin: 6px 0 0;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }

    #music-toggle {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #music-toggle::after {
      content: "▶️";
    }
    #music-toggle.pause::after {
      content: "⏸️";
    }
  </style>
</head>
<body>

  <!-- موزیک — بدون src اولیه، فقط وقتی لازم شد لود میشه -->
  <audio id="background-music" preload="none" loop></audio>

  <div class="header">
    <div class="brand">
      <div class="logo">T</div>
      <div>
        <div style="font-weight:800;font-size:18px">TOUCAN</div>
        <div style="font-size:13px;color:#ddd">منوی دیجیتال</div>
      </div>
    </div>
  </div>

  <div style="padding: 0 10px;">
    <div style="margin-bottom:10px">
      <strong>میز:</strong> <span id="table-number-display">—</span>
    </div>
    <div id="food-grid" class="food-grid"></div>
  </div>

  <!-- سبد خرید -->
  <div id="cart" class="cart-floating">
    <div style="flex:1">
      <div style="font-weight:800">فاکتور (<span id="cart-count">0</span>)</div>
      <div class="cart-list" id="cart-list"></div>
      <div style="margin-top:6px;font-weight:800">کل: <span id="cart-total">0</span> تومان</div>
    </div>
    <div class="cart-actions" style="display:flex;gap:8px">
      <button id="send-whatsapp" class="send-btn">ارسال به واتس‌اپ</button>
      <button id="clear-cart" class="send-btn" style="background:#eee;color:#000">پاک کردن</button>
      <button id="music-toggle" title="پخش/توقف"></button>
    </div>
  </div>

  <!-- modal -->
  <div id="modal" class="modal" style="display:none">
    <div style="background:white;padding:16px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3)">
      <h3>ارسال به واتس‌اپ</h3>
      <p>شماره آشپزخانه را وارد کنید.</p>
      <input type="text" id="whatsapp-input" placeholder="98912..." style="width:100%;padding:8px;margin:8px 0;border:1px solid #ccc;border-radius:4px">
      <button id="send-to-number" style="background:#4CAF50;color:white;padding:10px;border:none;border-radius:4px;cursor:pointer">ارسال</button>
    </div>
  </div>

  <script>
    // --- تنظیمات ---
    const CSV_PATH = 'data/foods.csv';
    const PLACEHOLDER = 'assets/images/placeholder.jpg';
    const table = new URLSearchParams(location.search).get('table') || localStorage.getItem('toucan_table') || '—';
    document.getElementById('table-number-display').textContent = table;
    localStorage.setItem('toucan_table', table);

    let foods = [];
    let cart = {};
    let isMusicInitialized = false;
    const music = document.getElementById('background-music');
    const toggleBtn = document.getElementById('music-toggle');

    // --- Lazy Load عکس‌ها + تأخیر در لود موزیک ---
    function initMusic() {
      if (isMusicInitialized) return;

      // تنظیم src فقط وقتی کاربر تعامل داشته باشد
      if (!music.src) {
        music.src = 'https://www.dash-smal.ir/assets/music/toucan/toucan.mp3';
      }

      music.muted = true;
      music.play().then(() => {
        music.muted = false;
        isMusicInitialized = true;
        music.play();
        toggleBtn.classList.add('pause');
      }).catch(() => {
        console.log("صدا نیاز به تعامل بیشتر دارد");
      });

      removeListeners();
    }

    function removeListeners() {
      document.removeEventListener('click', initMusic);
      document.removeEventListener('scroll', initMusicOnce);
      document.removeEventListener('touchstart', initMusic);
    }

    function initMusicOnce() {
      initMusic();
      removeListeners();
    }

    document.addEventListener('click', initMusic);
    document.addEventListener('touchstart', initMusic);
    document.addEventListener('scroll', initMusicOnce);

    // کنترل دکمه موسیقی
    toggleBtn.addEventListener('click', () => {
      if (music.paused) {
        music.play().catch(() => alert("لطفاً یک بار روی صفحه کلیک کنید."));
      } else {
        music.pause();
      }
    });

    music.addEventListener('play', () => toggleBtn.classList.add('pause'));
    music.addEventListener('pause', () => toggleBtn.classList.remove('pause'));

    // --- منو و سبد خرید ---
    async function fetchFoods() {
      try {
        const resp = await fetch(CSV_PATH + '?t=' + Date.now());
        const text = await resp.text();
        const rows = text.split('\n').filter(r => r.trim()).map(r => r.split(','));
        
        foods = rows.slice(1).map(r => ({
          id: r[0] || 'item',
          fa: r[1] || '',
          ingredients: r[2] || '',
          price: parseInt(r[3]) || 0,
          whatsapp: r[4] || '',
          img_name: r[5] || '',
          img_folder: r[6] || ''
        }));

        renderFoods();
      } catch (e) {
        console.error('خطا در بارگذاری منو', e);
      }
    }

    function makeImagePath(f) {
      if (f.img_folder && f.img_name) {
        return `${f.img_folder.trim()}/${f.img_name.trim()}`;
      }
      return PLACEHOLDER;
    }

    function renderFoods() {
      const grid = document.getElementById('food-grid');
      grid.innerHTML = '';
      foods.forEach(f => {
        const card = document.createElement('div');
        card.className = 'food-card';

        const img = document.createElement('img');
        img.src = makeImagePath(f);
        img.alt = f.fa;
        img.loading = 'lazy'; // لود تأخیری عکس
        img.className = 'food-img';

        const info = document.createElement('div');
        info.className = 'food-info';

        const h3 = document.createElement('h3'); h3.textContent = f.fa;
        const p = document.createElement('p'); p.textContent = f.ingredients;
        const controls = document.createElement('div'); controls.className = 'controls';

        const price = document.createElement('div');
        price.className = 'price';
        price.textContent = (f.price || 0).toLocaleString() + ' تومان';

        const btn = document.createElement('button');
        btn.className = 'add-btn';
        btn.textContent = 'افزودن';
        btn.onclick = () => addToCart(f);

        controls.appendChild(price);
        controls.appendChild(btn);
        info.appendChild(h3);
        info.appendChild(p);
        info.appendChild(controls);
        card.appendChild(img);
        card.appendChild(info);
        grid.appendChild(card);
      });
    }

    // --- سبد خرید ---
    function addToCart(food) {
      const id = food.id;
      if (!cart[id]) cart[id] = { ...food, qty: 0 };
      cart[id].qty++;
      saveCart();
      renderCart();
    }

    function renderCart() {
      const list = document.getElementById('cart-list');
      list.innerHTML = '';
      let total = 0, count = 0;

      for (const id in cart) {
        const it = cart[id];
        count += it.qty;
        total += it.price * it.qty;

        const row = document.createElement('div');
        row.className = 'cart-item';
        row.innerHTML = `
          <span>${it.fa} ×${it.qty}</span>
          <button onclick="removeFromCart('${id}')">حذف</button>
        `;
        list.appendChild(row);
      }

      document.getElementById('cart-total').textContent = total.toLocaleString();
      document.getElementById('cart-count').textContent = count;
    }

    function removeFromCart(id) {
      delete cart[id];
      saveCart();
      renderCart();
    }

    function saveCart() {
      try {
        localStorage.setItem('toucan_cart', JSON.stringify(cart));
      } catch (e) {}
    }

    function loadCart() {
      try {
        const raw = localStorage.getItem('toucan_cart');
        if (raw) cart = JSON.parse(raw);
      } catch (e) {}
      renderCart();
    }

    // --- ارسال به واتس‌اپ ---
    document.getElementById('send-whatsapp').addEventListener('click', () => {
      const msg = Object.entries(cart).map(([id, it]) =>
        `${it.qty}× ${it.fa} (${it.price.toLocaleString()} تومان)`
      ).join('\n');
      
      if (!msg) return alert('سبد خالی است');

      const text = `سفارش جدید - TOUCAN\nمیز: ${table}\n\n${msg}\n\nجمع: ${Object.values(cart).reduce((a, b) => a + b.price * b.qty, 0).toLocaleString()} تومان`;
      
      const modal = document.getElementById('modal');
      const input = document.getElementById('whatsapp-input');
      const sendBtn = document.getElementById('send-to-number');

      input.value = '';
      modal.style.display = 'block';

      sendBtn.onclick = () => {
        const num = input.value.replace(/\D/g, '');
        if (num) {
          window.open(`https://wa.me/${num}?text=${encodeURIComponent(text)}`, '_blank');
          modal.style.display = 'none';
        }
      };

      modal.onclick = () => modal.style.display = 'none';
      document.querySelector('.modal > div').onclick = e => e.stopPropagation();
    });

    document.getElementById('clear-cart').addEventListener('click', () => {
      if (confirm('پاک کنیم؟')) {
        cart = {};
        saveCart();
        renderCart();
      }
    });

    // --- اجرا ---
    loadCart();
    fetchFoods();
  </script>
</body>
</html>
